rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection for username-based auth
    match /users/{userId} {
      allow read: if request.auth != null; // Restrict user data access to authenticated users
      allow write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      // Allow admins to create employee accounts
      allow write: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }
    
    // Users can read/write their own settings
    match /userSettings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Jobs collection - enhanced for notification system
    match /jobs/{jobId} {
      allow read, list: if request.auth != null; // Require authentication for job data
      allow write: if request.auth != null;
      // Allow cleaner location updates for notifications
      allow update: if request.auth != null && 
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['cleanerLocation', 'cleanerDistance', 'status', 'actualStartTime', 'updatedAt']);
    }
    
    // Guest bookings - anyone can create, read, and query
    match /guest-bookings/{bookingId} {
      allow create, read, list, get: if true;
      allow update, delete: if request.auth != null;
    }
    
    // Client profiles - enhanced for push notifications
    match /clients/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Allow push token updates for notifications
      allow update: if request.auth != null && request.auth.uid == userId &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['pushToken', 'updatedAt', 'settings']);
    }
    
    // Allow authenticated users to read employee profiles
    match /employees/{userId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read admin profiles
    match /admins/{userId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to create/read bookings
    match /bookings/{bookingId} {
      allow read, list: if request.auth != null; // Require authentication for booking data
      allow write: if request.auth != null;
    }
    
    // Work requests collection
    match /workRequests/{requestId} {
      allow read, list: if request.auth != null; // Require authentication for work requests
      allow write: if request.auth != null;
    }
    
    // Messages collection - authenticated users and guests can create/read
    match /messages/{messageId} {
      allow read, list: if request.auth != null; // Require authentication for messages
      allow write: if request.auth != null;
      allow create: if request.auth != null; // Require authentication to create messages
    }
    
    // Chat collections for internal messaging
    match /chats/{chatId} {
      allow read, write, create: if request.auth != null;
    }
    
    // News collection - all authenticated users can read/write
    match /news/{newsId} {
      allow read, write: if request.auth != null;
    }
    
    // Task templates collection
    match /taskTemplates/{templateId} {
      allow read, write: if request.auth != null;
    }
    
    // Job attachments (images/videos)
    match /jobAttachments/{attachmentId} {
      allow read, write: if request.auth != null;
    }
    
    // IoT sensor data
    match /sensorData/{sensorId} {
      allow read, write: if request.auth != null;
    }
    
    // Venue floorplans
    match /floorplans/{floorplanId} {
      allow read, write: if request.auth != null;
    }
    
    // Recycle bin status
    match /recycleBins/{binId} {
      allow read, write: if request.auth != null;
    }
    
    // Employee equipment assignments
    match /equipment/{equipmentId} {
      allow read, write: if request.auth != null;
    }
    
    // Employee unavailability requests
    match /unavailability/{requestId} {
      allow read, write: if request.auth != null;
    }
    
    // Employee schedules
    match /schedules/{scheduleId} {
      allow read, write: if request.auth != null;
    }
    
    // Equipment maintenance logs
    match /maintenance/{maintenanceId} {
      allow read, write: if request.auth != null;
    }
    
    // Task completions
    match /taskCompletions/{completionId} {
      allow read, write: if request.auth != null;
    }
    
    // Client settings for notifications
    match /clientSettings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}